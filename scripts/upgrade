#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

app_install_inside_container=$(ynh_app_setting_get --key=app_install_inside_container)
if [ -z "$app_install_inside_container" ]
then
    if [[ -f "$data_dir/garage_data.qcow2" ]]
    then 
        app_install_inside_container=false
        # comment_if_no_data_mount=""
        # https://mattgadient.com/how-to-using-systemd-to-mount-nbd-devices-on-boot-ubuntu/
        mount_disk
        ynh_config_add_systemd --mount="$app""_data" --template=data.mount
        yunohost service add garage_data_mounted --description="Garage Data Mounted"
        ynh_systemctl --service=garage_data_mounted --action="start" --log_path="systemd"# --line_match="Started Garage: Data Store."
    else
        app_install_inside_container=true
        # comment_if_no_data_mount="#"
        # comment_if_system_is_inside_container="#"
    fi
    data="no"
    metadata="no"
    # comment_if_no_metadata_mount="#"
    ynh_app_setting_set --key=data --value=$data
    ynh_app_setting_set --key=metadata --value=$metadata
    ynh_app_setting_set --key=app_install_inside_container --value=$app_install_inside_container
    ynh_safe_rm "$install_dir/mount_disk.sh"
    ynh_safe_rm "$install_dir/umount_disk.sh"
fi

#=================================================
# GET CONFIG PANEL SETTINGS
#=================================================
weight=$(ynh_app_setting_get --key=weight)
bootstrap_peers=$(ynh_app_setting_get --key=bootstrap_peers)
rpc_secret=$(ynh_app_setting_get --key=rpc_secret)

#=================================================
# CHECK IF THE APP CAN BE UPGRADED WITH THESE ARGS
#=================================================

if [[ "$app_install_inside_container" != system_is_inside_container ]]
then
    ynh_die "Physical config of your server changed since initial Garage Install. Please reinstall"
fi
comment_if_no_data_mount=""
comment_if_no_metadata_mount=""
comment_if_system_is_inside_container=""
if [[ "$data" == "no" ]]
then
    comment_if_no_data_mount="#"
fi
if [[ "$metadata" == "no" ]]
then
    comment_if_no_metadata_mount="#"
fi

if ! $app_install_inside_container
then
    system_is_inside_container_bool="false"
else #we are in a container, we keep all partitions as is
    system_is_inside_container_bool="true"
fi

if ! $app_install_inside_container && ([[ "$data" == "no" ]] || [[ "$metadata" == "no" ]])
then
    # used to comment systemd isolation to allow mount disk
    comment_if_system_is_inside_container="#"
fi

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service=$app --action="stop"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading source files..."

ynh_setup_source --dest_dir="$install_dir" --keep="garage.toml" --source_id="binaries" # resources.sources.main is a dummy source, see manifest.toml

chmod +x $install_dir/garage

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression "Upgrading NGINX web server configuration..."

if ynh_in_ci_tests
then
    cat << EOF > ../conf/nginx.conf
location / {
    return 200 'This is a dummy page for Garage, only displayed during tests on YunoHost CI';
}
EOF
fi
ynh_config_add_nginx

ynh_config_add --template="regenconf_nginx_garage" --destination="/usr/share/yunohost/hooks/conf_regen/98-nginx_$app"
yunohost tools regen-conf nginx

ynh_config_add_systemd

ynh_config_add_logrotate

yunohost service add $app --description="s3 storage" --log="/var/log/$app/$app.log" --needs_exposed_ports=$port

#=================================================
# UPDATE A CONFIG FILE
#=================================================
#ynh_script_progression "Updating configuration..."

#ynh_config_add --template="garage.toml" --destination="$install_dir/garage.toml"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service=$app --action="start"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
